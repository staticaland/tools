<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kitchen: {
                            cabinet: '#d4a574',
                            cabinetDark: '#b8956a',
                            counter: '#4a4a4a',
                            appliance: '#e8e8e8',
                            applianceDark: '#c0c0c0',
                            handle: '#888888'
                        },
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .grid-canvas {
            background-image:
                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #f9fafb;
        }
        .palette-item {
            cursor: grab;
            user-select: none;
            transition: all 0.15s ease;
        }
        .palette-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .palette-item:active {
            cursor: grabbing;
        }
        .canvas-item {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.15s ease;
        }
        .canvas-item:hover {
            z-index: 100;
        }
        .canvas-item.selected {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
            z-index: 101;
        }
        .canvas-item.dragging {
            opacity: 0.8;
            z-index: 1000;
            cursor: grabbing;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4f46e5;
            border: 2px solid white;
            border-radius: 2px;
            z-index: 102;
        }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.w { top: 50%; left: -5px; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.e { top: 50%; right: -5px; transform: translateY(-50%); cursor: e-resize; }
        .ghost-item {
            position: absolute;
            pointer-events: none;
            opacity: 0.5;
            z-index: 999;
        }
        .item-label {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            font-size: 10px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            pointer-events: none;
        }
        .appliance-label {
            color: #4a5568;
            text-shadow: none;
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .toolbar-btn:hover {
            background: #e5e7eb;
        }
        .toolbar-btn.active {
            background: #e0e7ff;
            color: #4f46e5;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen overflow-hidden">
    <div class="h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-semibold text-gray-800">Kitchen Designer</h1>
                <div class="h-6 w-px bg-gray-200"></div>
                <div class="flex items-center gap-1">
                    <button onclick="undo()" class="toolbar-btn" title="Undo (Ctrl+Z)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                        </svg>
                    </button>
                    <button onclick="redo()" class="toolbar-btn" title="Redo (Ctrl+Y)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="h-6 w-px bg-gray-200"></div>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <label class="flex items-center gap-1">
                        Grid:
                        <select id="gridSize" onchange="updateGridSize()" class="border border-gray-200 rounded px-2 py-1 text-sm">
                            <option value="10">10px</option>
                            <option value="20" selected>20px</option>
                            <option value="40">40px</option>
                        </select>
                    </label>
                    <label class="flex items-center gap-2 ml-2">
                        <input type="checkbox" id="snapToggle" checked onchange="toggleSnap()" class="rounded">
                        Snap
                    </label>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="shareDesign()" class="h-9 px-3 text-sm font-medium bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share
                </button>
                <button onclick="exportDesign()" class="h-9 px-3 text-sm font-medium bg-gray-100 text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
                <button onclick="document.getElementById('importInput').click()" class="h-9 px-3 text-sm font-medium bg-gray-100 text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Import
                </button>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importDesign(event)">
                <button onclick="clearCanvas()" class="h-9 px-3 text-sm font-medium bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 transition-colors">
                    Clear
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar - Palette -->
            <aside class="w-56 bg-white border-r border-gray-200 overflow-y-auto shrink-0">
                <div class="p-3">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Components</h2>

                    <div class="space-y-4">
                        <!-- Cabinets -->
                        <div>
                            <h3 class="text-xs font-medium text-gray-400 mb-2">Cabinets</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="palette-item bg-kitchen-cabinet border-2 border-kitchen-cabinetDark rounded-lg p-2 text-center"
                                     data-type="cabinet" data-width="80" data-height="60" data-name="Cabinet">
                                    <div class="w-full h-8 flex items-center justify-center">
                                        <div class="w-6 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-white font-medium mt-1">Cabinet</div>
                                </div>
                                <div class="palette-item bg-kitchen-cabinet border-2 border-kitchen-cabinetDark rounded-lg p-2 text-center"
                                     data-type="upper-cabinet" data-width="80" data-height="80" data-name="Upper">
                                    <div class="w-full h-10 flex items-center justify-center">
                                        <div class="w-6 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-white font-medium mt-1">Upper</div>
                                </div>
                                <div class="palette-item bg-kitchen-cabinet border-2 border-kitchen-cabinetDark rounded-lg p-2 text-center"
                                     data-type="drawer" data-width="80" data-height="40" data-name="Drawer">
                                    <div class="w-full h-4 flex items-center justify-center">
                                        <div class="w-8 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-white font-medium">Drawer</div>
                                </div>
                                <div class="palette-item bg-kitchen-cabinet border-2 border-kitchen-cabinetDark rounded-lg p-2 text-center"
                                     data-type="corner-cabinet" data-width="80" data-height="80" data-name="Corner">
                                    <div class="w-full h-10 flex items-center justify-center">
                                        <div class="w-4 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-white font-medium mt-1">Corner</div>
                                </div>
                                <div class="palette-item bg-kitchen-cabinet border-2 border-kitchen-cabinetDark rounded-lg p-2 text-center"
                                     data-type="pantry" data-width="60" data-height="120" data-name="Pantry">
                                    <div class="w-full h-16 flex items-center justify-center">
                                        <div class="w-6 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-white font-medium">Pantry</div>
                                </div>
                            </div>
                        </div>

                        <!-- Appliances -->
                        <div>
                            <h3 class="text-xs font-medium text-gray-400 mb-2">Appliances</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="palette-item bg-kitchen-appliance border-2 border-kitchen-applianceDark rounded-lg p-2 text-center"
                                     data-type="fridge" data-width="80" data-height="120" data-name="Fridge">
                                    <div class="w-full h-16 flex flex-col">
                                        <div class="flex-1 border-b border-kitchen-applianceDark"></div>
                                        <div class="flex-[2]"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 font-medium">Fridge</div>
                                </div>
                                <div class="palette-item bg-kitchen-appliance border-2 border-kitchen-applianceDark rounded-lg p-2 text-center"
                                     data-type="oven" data-width="80" data-height="100" data-name="Oven">
                                    <div class="w-full h-4 flex items-center justify-center gap-1">
                                        <div class="w-2 h-2 rounded-full border border-gray-400"></div>
                                        <div class="w-2 h-2 rounded-full border border-gray-400"></div>
                                        <div class="w-2 h-2 rounded-full border border-gray-400"></div>
                                        <div class="w-2 h-2 rounded-full border border-gray-400"></div>
                                    </div>
                                    <div class="flex-1 mt-1 border-t border-kitchen-applianceDark"></div>
                                    <div class="text-xs text-gray-600 font-medium mt-1">Oven</div>
                                </div>
                                <div class="palette-item bg-kitchen-appliance border-2 border-kitchen-applianceDark rounded-lg p-2 text-center"
                                     data-type="dishwasher" data-width="80" data-height="80" data-name="Dishwasher">
                                    <div class="w-full h-10 flex items-start justify-center pt-1">
                                        <div class="w-8 h-1 bg-kitchen-handle rounded"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 font-medium">Dishwasher</div>
                                </div>
                                <div class="palette-item bg-kitchen-appliance border-2 border-kitchen-applianceDark rounded-lg p-2 text-center"
                                     data-type="microwave" data-width="60" data-height="40" data-name="Microwave">
                                    <div class="w-full h-4 border border-gray-300 rounded"></div>
                                    <div class="text-xs text-gray-600 font-medium mt-1">Microwave</div>
                                </div>
                            </div>
                        </div>

                        <!-- Surfaces -->
                        <div>
                            <h3 class="text-xs font-medium text-gray-400 mb-2">Surfaces</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="palette-item bg-kitchen-counter rounded-lg p-2 text-center"
                                     data-type="counter" data-width="100" data-height="40" data-name="Counter">
                                    <div class="w-full h-6"></div>
                                    <div class="text-xs text-gray-300 font-medium">Counter</div>
                                </div>
                                <div class="palette-item bg-slate-500 rounded-lg p-2 text-center"
                                     data-type="sink" data-width="80" data-height="60" data-name="Sink">
                                    <div class="w-full h-8 border-2 border-slate-400 rounded"></div>
                                    <div class="text-xs text-gray-200 font-medium mt-1">Sink</div>
                                </div>
                                <div class="palette-item bg-amber-100 border-2 border-amber-200 rounded-lg p-2 text-center"
                                     data-type="island" data-width="120" data-height="80" data-name="Island">
                                    <div class="w-full h-10"></div>
                                    <div class="text-xs text-amber-700 font-medium">Island</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Canvas Area -->
            <main class="flex-1 overflow-auto relative bg-slate-200 p-4">
                <div id="canvas" class="grid-canvas relative bg-white rounded-lg shadow-inner"
                     style="width: 1200px; height: 800px;"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)">
                    <!-- Canvas items will be rendered here -->
                </div>
                <div id="ghostItem" class="ghost-item hidden"></div>
            </main>

            <!-- Right Sidebar - Properties -->
            <aside id="propertiesPanel" class="w-64 bg-white border-l border-gray-200 overflow-y-auto shrink-0 hidden">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-semibold text-gray-800">Properties</h2>
                        <button onclick="deselectAll()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Name</label>
                            <input type="text" id="propName" class="w-full h-9 px-3 text-sm border border-gray-200 rounded-lg focus:border-primary-400 focus:ring-1 focus:ring-primary-400 outline-none" onchange="updateSelectedProperty('name', this.value)">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Contents</label>
                            <textarea id="propContents" rows="3" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:border-primary-400 focus:ring-1 focus:ring-primary-400 outline-none resize-none" onchange="updateSelectedProperty('contents', this.value)" placeholder="What's stored here?"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">X</label>
                                <input type="number" id="propX" class="w-full h-9 px-3 text-sm border border-gray-200 rounded-lg focus:border-primary-400 outline-none" onchange="updateSelectedProperty('x', parseInt(this.value))">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Y</label>
                                <input type="number" id="propY" class="w-full h-9 px-3 text-sm border border-gray-200 rounded-lg focus:border-primary-400 outline-none" onchange="updateSelectedProperty('y', parseInt(this.value))">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Width</label>
                                <input type="number" id="propWidth" class="w-full h-9 px-3 text-sm border border-gray-200 rounded-lg focus:border-primary-400 outline-none" onchange="updateSelectedProperty('width', parseInt(this.value))">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Height</label>
                                <input type="number" id="propHeight" class="w-full h-9 px-3 text-sm border border-gray-200 rounded-lg focus:border-primary-400 outline-none" onchange="updateSelectedProperty('height', parseInt(this.value))">
                            </div>
                        </div>
                        <div class="pt-2">
                            <button onclick="duplicateSelected()" class="w-full h-9 text-sm font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors mb-2">
                                Duplicate
                            </button>
                            <button onclick="deleteSelected()" class="w-full h-9 text-sm font-medium bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Status bar -->
        <footer class="bg-white border-t border-gray-200 px-4 py-1 flex items-center justify-between text-xs text-gray-500 shrink-0">
            <div id="statusText">Click and drag items from the palette to the canvas</div>
            <div id="itemCount">0 items</div>
        </footer>
    </div>

    <script>
        // State
        let items = [];
        let selectedId = null;
        let gridSize = 20;
        let snapEnabled = true;
        let undoStack = [];
        let redoStack = [];
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeHandle = null;
        let resizeStart = { x: 0, y: 0, width: 0, height: 0, itemX: 0, itemY: 0 };

        const STORAGE_KEY = 'kitchenDesigner';

        // Generate unique ID
        function generateId() {
            return 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Snap to grid
        function snap(value) {
            if (!snapEnabled) return value;
            return Math.round(value / gridSize) * gridSize;
        }

        // Save state for undo
        function saveState() {
            undoStack.push(JSON.stringify(items));
            if (undoStack.length > 50) undoStack.shift();
            redoStack = [];
        }

        function undo() {
            if (undoStack.length === 0) return;
            redoStack.push(JSON.stringify(items));
            items = JSON.parse(undoStack.pop());
            renderCanvas();
            saveToStorage();
        }

        function redo() {
            if (redoStack.length === 0) return;
            undoStack.push(JSON.stringify(items));
            items = JSON.parse(redoStack.pop());
            renderCanvas();
            saveToStorage();
        }

        // Storage
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            updateItemCount();
        }

        function loadFromStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    items = JSON.parse(saved);
                } catch (e) {
                    items = [];
                }
            }
        }

        function updateItemCount() {
            document.getElementById('itemCount').textContent = `${items.length} item${items.length !== 1 ? 's' : ''}`;
        }

        // Grid size
        function updateGridSize() {
            gridSize = parseInt(document.getElementById('gridSize').value);
            const canvas = document.getElementById('canvas');
            canvas.style.backgroundSize = `${gridSize}px ${gridSize}px`;
        }

        function toggleSnap() {
            snapEnabled = document.getElementById('snapToggle').checked;
        }

        // Render canvas items
        function renderCanvas() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';

            items.forEach(item => {
                const el = createItemElement(item);
                canvas.appendChild(el);
            });

            updateItemCount();

            if (selectedId) {
                const selectedItem = items.find(i => i.id === selectedId);
                if (selectedItem) {
                    updatePropertiesPanel(selectedItem);
                } else {
                    deselectAll();
                }
            }
        }

        function createItemElement(item) {
            const el = document.createElement('div');
            el.id = item.id;
            el.className = `canvas-item ${item.id === selectedId ? 'selected' : ''}`;
            el.style.left = `${item.x}px`;
            el.style.top = `${item.y}px`;
            el.style.width = `${item.width}px`;
            el.style.height = `${item.height}px`;

            // Set appearance based on type
            const typeStyles = getTypeStyles(item.type);
            el.innerHTML = typeStyles.html;
            Object.assign(el.style, typeStyles.style);

            // Add label if contents exist
            if (item.contents) {
                const label = document.createElement('div');
                label.className = `item-label ${item.type === 'fridge' || item.type === 'oven' || item.type === 'dishwasher' || item.type === 'microwave' ? 'appliance-label' : ''}`;
                label.textContent = item.contents;
                el.appendChild(label);
            }

            // Add resize handles if selected
            if (item.id === selectedId) {
                ['nw', 'ne', 'sw', 'se', 'n', 's', 'w', 'e'].forEach(handle => {
                    const h = document.createElement('div');
                    h.className = `resize-handle ${handle}`;
                    h.dataset.handle = handle;
                    el.appendChild(h);
                });
            }

            // Event listeners
            el.addEventListener('mousedown', (e) => handleItemMouseDown(e, item));
            el.addEventListener('dblclick', () => editItemContents(item));

            return el;
        }

        function getTypeStyles(type) {
            const styles = {
                'cabinet': {
                    style: { background: '#d4a574', border: '2px solid #b8956a', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'upper-cabinet': {
                    style: { background: '#d4a574', border: '2px solid #b8956a', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'drawer': {
                    style: { background: '#d4a574', border: '2px solid #b8956a', borderRadius: '4px' },
                    html: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'corner-cabinet': {
                    style: { background: '#d4a574', border: '2px solid #b8956a', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'pantry': {
                    style: { background: '#d4a574', border: '2px solid #b8956a', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'fridge': {
                    style: { background: '#e8e8e8', border: '2px solid #c0c0c0', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:0;left:0;right:0;height:35%;border-bottom:2px solid #c0c0c0;"></div><div style="position:absolute;top:18%;right:8px;width:4px;height:16px;background:#888;border-radius:2px;"></div><div style="position:absolute;top:50%;right:8px;width:4px;height:24px;background:#888;border-radius:2px;"></div>'
                },
                'oven': {
                    style: { background: '#e8e8e8', border: '2px solid #c0c0c0', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:8px;"><div style="width:12px;height:12px;border-radius:50%;border:2px solid #888;"></div><div style="width:12px;height:12px;border-radius:50%;border:2px solid #888;"></div><div style="width:12px;height:12px;border-radius:50%;border:2px solid #888;"></div><div style="width:12px;height:12px;border-radius:50%;border:2px solid #888;"></div></div><div style="position:absolute;top:32px;left:8px;right:8px;bottom:8px;border-top:2px solid #c0c0c0;"></div>'
                },
                'dishwasher': {
                    style: { background: '#e8e8e8', border: '2px solid #c0c0c0', borderRadius: '8px' },
                    html: '<div style="position:absolute;top:12px;left:50%;transform:translateX(-50%);width:32px;height:4px;background:#888;border-radius:2px;"></div>'
                },
                'microwave': {
                    style: { background: '#e8e8e8', border: '2px solid #c0c0c0', borderRadius: '6px' },
                    html: '<div style="position:absolute;top:8px;left:8px;right:24px;bottom:8px;border:2px solid #c0c0c0;border-radius:4px;"></div><div style="position:absolute;top:50%;right:12px;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;background:#888;"></div>'
                },
                'counter': {
                    style: { background: '#4a4a4a', borderRadius: '4px' },
                    html: ''
                },
                'sink': {
                    style: { background: '#64748b', borderRadius: '6px' },
                    html: '<div style="position:absolute;top:8px;left:8px;right:8px;bottom:8px;border:3px solid #94a3b8;border-radius:6px;"></div>'
                },
                'island': {
                    style: { background: '#fef3c7', border: '2px solid #fde68a', borderRadius: '8px' },
                    html: ''
                }
            };

            return styles[type] || styles['cabinet'];
        }

        // Handle palette drag start
        document.querySelectorAll('.palette-item').forEach(item => {
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', handlePaletteDragStart);
            item.addEventListener('dragend', handlePaletteDragEnd);
        });

        function handlePaletteDragStart(e) {
            const data = {
                type: e.target.dataset.type,
                width: parseInt(e.target.dataset.width),
                height: parseInt(e.target.dataset.height),
                name: e.target.dataset.name
            };
            e.dataTransfer.setData('application/json', JSON.stringify(data));
            e.dataTransfer.effectAllowed = 'copy';

            // Create ghost
            const ghost = document.getElementById('ghostItem');
            const styles = getTypeStyles(data.type);
            ghost.style.width = `${data.width}px`;
            ghost.style.height = `${data.height}px`;
            Object.assign(ghost.style, styles.style);
            ghost.innerHTML = styles.html;
        }

        function handlePaletteDragEnd(e) {
            const ghost = document.getElementById('ghostItem');
            ghost.classList.add('hidden');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';

            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = snap(e.clientX - rect.left);
            const y = snap(e.clientY - rect.top);

            const ghost = document.getElementById('ghostItem');
            ghost.classList.remove('hidden');
            ghost.style.left = `${x + rect.left}px`;
            ghost.style.top = `${y + rect.top}px`;
        }

        function handleDrop(e) {
            e.preventDefault();
            const ghost = document.getElementById('ghostItem');
            ghost.classList.add('hidden');

            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();

            const x = snap(e.clientX - rect.left - data.width / 2);
            const y = snap(e.clientY - rect.top - data.height / 2);

            saveState();

            const newItem = {
                id: generateId(),
                type: data.type,
                name: data.name,
                x: Math.max(0, x),
                y: Math.max(0, y),
                width: data.width,
                height: data.height,
                contents: ''
            };

            items.push(newItem);
            saveToStorage();
            selectItem(newItem.id);
            renderCanvas();

            document.getElementById('statusText').textContent = `Added ${data.name}`;
        }

        // Handle canvas item interactions
        function handleItemMouseDown(e, item) {
            e.stopPropagation();

            // Check if clicking resize handle
            if (e.target.classList.contains('resize-handle')) {
                startResize(e, item);
                return;
            }

            selectItem(item.id);
            startDrag(e, item);
        }

        function selectItem(id) {
            selectedId = id;
            renderCanvas();

            const item = items.find(i => i.id === id);
            if (item) {
                updatePropertiesPanel(item);
                document.getElementById('propertiesPanel').classList.remove('hidden');
            }
        }

        function deselectAll() {
            selectedId = null;
            document.getElementById('propertiesPanel').classList.add('hidden');
            renderCanvas();
        }

        function updatePropertiesPanel(item) {
            document.getElementById('propName').value = item.name || '';
            document.getElementById('propContents').value = item.contents || '';
            document.getElementById('propX').value = item.x;
            document.getElementById('propY').value = item.y;
            document.getElementById('propWidth').value = item.width;
            document.getElementById('propHeight').value = item.height;
        }

        function updateSelectedProperty(prop, value) {
            if (!selectedId) return;
            const item = items.find(i => i.id === selectedId);
            if (!item) return;

            saveState();

            if (prop === 'x' || prop === 'y') {
                value = snap(value);
            }
            if (prop === 'width' || prop === 'height') {
                value = Math.max(gridSize, snap(value));
            }

            item[prop] = value;
            saveToStorage();
            renderCanvas();
        }

        // Drag functionality
        function startDrag(e, item) {
            isDragging = true;
            const el = document.getElementById(item.id);
            const rect = el.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            el.classList.add('dragging');
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function handleDrag(e) {
            if (!isDragging || !selectedId) return;

            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const item = items.find(i => i.id === selectedId);
            if (!item) return;

            let x = e.clientX - rect.left - dragOffset.x;
            let y = e.clientY - rect.top - dragOffset.y;

            x = snap(Math.max(0, Math.min(x, 1200 - item.width)));
            y = snap(Math.max(0, Math.min(y, 800 - item.height)));

            const el = document.getElementById(selectedId);
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;

            // Store temporarily
            item._tempX = x;
            item._tempY = y;
        }

        function stopDrag(e) {
            if (!isDragging) return;
            isDragging = false;

            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', stopDrag);

            const item = items.find(i => i.id === selectedId);
            if (item && (item._tempX !== undefined || item._tempY !== undefined)) {
                if (item._tempX !== item.x || item._tempY !== item.y) {
                    saveState();
                    item.x = item._tempX !== undefined ? item._tempX : item.x;
                    item.y = item._tempY !== undefined ? item._tempY : item.y;
                    delete item._tempX;
                    delete item._tempY;
                    saveToStorage();
                }
            }

            renderCanvas();
        }

        // Resize functionality
        function startResize(e, item) {
            e.stopPropagation();
            isResizing = true;
            resizeHandle = e.target.dataset.handle;
            resizeStart = {
                x: e.clientX,
                y: e.clientY,
                width: item.width,
                height: item.height,
                itemX: item.x,
                itemY: item.y
            };

            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }

        function handleResize(e) {
            if (!isResizing || !selectedId) return;

            const item = items.find(i => i.id === selectedId);
            if (!item) return;

            const dx = e.clientX - resizeStart.x;
            const dy = e.clientY - resizeStart.y;

            let newWidth = resizeStart.width;
            let newHeight = resizeStart.height;
            let newX = resizeStart.itemX;
            let newY = resizeStart.itemY;

            if (resizeHandle.includes('e')) {
                newWidth = snap(Math.max(gridSize, resizeStart.width + dx));
            }
            if (resizeHandle.includes('w')) {
                const potentialWidth = resizeStart.width - dx;
                newWidth = snap(Math.max(gridSize, potentialWidth));
                newX = snap(resizeStart.itemX + (resizeStart.width - newWidth));
            }
            if (resizeHandle.includes('s')) {
                newHeight = snap(Math.max(gridSize, resizeStart.height + dy));
            }
            if (resizeHandle.includes('n')) {
                const potentialHeight = resizeStart.height - dy;
                newHeight = snap(Math.max(gridSize, potentialHeight));
                newY = snap(resizeStart.itemY + (resizeStart.height - newHeight));
            }

            const el = document.getElementById(selectedId);
            el.style.width = `${newWidth}px`;
            el.style.height = `${newHeight}px`;
            el.style.left = `${newX}px`;
            el.style.top = `${newY}px`;

            item._tempWidth = newWidth;
            item._tempHeight = newHeight;
            item._tempX = newX;
            item._tempY = newY;
        }

        function stopResize(e) {
            if (!isResizing) return;
            isResizing = false;

            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);

            const item = items.find(i => i.id === selectedId);
            if (item && item._tempWidth !== undefined) {
                saveState();
                item.width = item._tempWidth;
                item.height = item._tempHeight;
                item.x = item._tempX;
                item.y = item._tempY;
                delete item._tempWidth;
                delete item._tempHeight;
                delete item._tempX;
                delete item._tempY;
                saveToStorage();
            }

            renderCanvas();
        }

        // Edit contents
        function editItemContents(item) {
            const contents = prompt(`What's stored in ${item.name}?`, item.contents || '');
            if (contents !== null) {
                saveState();
                item.contents = contents;
                saveToStorage();
                renderCanvas();
            }
        }

        // Actions
        function duplicateSelected() {
            if (!selectedId) return;
            const item = items.find(i => i.id === selectedId);
            if (!item) return;

            saveState();

            const newItem = {
                ...item,
                id: generateId(),
                x: snap(item.x + gridSize * 2),
                y: snap(item.y + gridSize * 2)
            };

            items.push(newItem);
            saveToStorage();
            selectItem(newItem.id);
            renderCanvas();
        }

        function deleteSelected() {
            if (!selectedId) return;
            saveState();
            items = items.filter(i => i.id !== selectedId);
            saveToStorage();
            deselectAll();
            renderCanvas();
        }

        function clearCanvas() {
            if (!confirm('Clear all items from the canvas?')) return;
            saveState();
            items = [];
            saveToStorage();
            deselectAll();
            renderCanvas();
        }

        // Import/Export
        function exportDesign() {
            const data = JSON.stringify({ items, version: 1 }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kitchen-design.json';
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('statusText').textContent = 'Design exported';
        }

        function importDesign(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.items) {
                        saveState();
                        items = data.items;
                        saveToStorage();
                        renderCanvas();
                        document.getElementById('statusText').textContent = 'Design imported';
                    }
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        // Share via URL
        function shareDesign() {
            const data = LZString.compressToEncodedURIComponent(JSON.stringify({ items }));
            const url = window.location.origin + window.location.pathname + '#' + data;

            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('statusText').textContent = `Link copied! (${url.length} chars)`;
            }).catch(() => {
                prompt('Copy this link:', url);
            });
        }

        function loadFromURL() {
            const hash = window.location.hash.slice(1);
            if (!hash) return false;

            try {
                const json = LZString.decompressFromEncodedURIComponent(hash);
                if (json) {
                    const data = JSON.parse(json);
                    if (data.items) {
                        items = data.items;
                        saveToStorage();
                        history.replaceState(null, '', window.location.pathname);
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load from URL:', e);
            }
            return false;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelected();
            }
            if (e.key === 'Escape') {
                deselectAll();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
            }
        });

        // Click on canvas to deselect
        document.getElementById('canvas').addEventListener('click', (e) => {
            if (e.target.id === 'canvas') {
                deselectAll();
            }
        });

        // Initialize
        loadFromURL() || loadFromStorage();
        renderCanvas();
    </script>
</body>
</html>
